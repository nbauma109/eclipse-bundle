name: Eclipse + SonarLint + de.jcup (Windows x64)

on:
  schedule:
    - cron: '0 17 * * 6'   # Saturdays at 17:00 UTC
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install deps
        run: |
          sudo apt-get update -y
          sudo apt-get install -y unzip zip xz-utils p7zip-full rsync jq curl default-jre-headless

      - name: Make scripts executable
        run: chmod +x scripts/*.sh

      - name: Get latest Eclipse train
        id: train
        run: scripts/get_train.sh

      - name: Get latest SonarLint (GitHub)
        id: sonarlint
        env:
          GH_TOKEN: ${{ github.token }}
        run: scripts/get_sonarlint.sh

      - name: Decide release tag
        id: decide
        env:
          GH_TOKEN: ${{ github.token }}
        run: scripts/decide_tag.sh

      - name: Stop if release exists
        if: env.SKIP == 'true'
        run: echo "Release ${TAG} already exists — skipping."

      - name: Download Eclipse (Windows & Linux)
        if: env.SKIP != 'true'
        run: scripts/download_eclipse.sh

      - name: Unpack Linux Eclipse (for p2)
        if: env.SKIP != 'true'
        run: scripts/unpack_linux.sh

      - name: Resolve IUs
        if: env.SKIP != 'true'
        run: scripts/resolve_ius.sh

      - name: Install plugins via p2
        if: env.SKIP != 'true'
        run: scripts/p2_install.sh

      - name: Build dropins/
        if: env.SKIP != 'true'
        run: scripts/build_dropins.sh

      - name: Prune & expand SonarLint sloop (Windows x64)
        if: env.SKIP != 'true'
        run: scripts/prune_sloop_win.sh

      - name: Package Windows distro
        if: env.SKIP != 'true'
        id: packwin
        run: scripts/pack_windows.sh

      - name: Write release notes
        if: env.SKIP != 'true'
        run: scripts/write_notes.sh

      - name: Publish release
        if: env.SKIP != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release create "${TAG}" \
            "${WIN_OUT}" \
            --title "Eclipse Java (Windows x64) + SonarLint ${SONARLINT_VERSION} + de.jcup – ${TRAIN}" \
            --notes-file RELEASE_NOTES.md
