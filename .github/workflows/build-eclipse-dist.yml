name: Eclipse + SonarLint (Windows x64)

on:
  schedule:
    - cron: '0 17 * * 6'   # Saturdays at 17:00 UTC
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get latest Eclipse SimRel train
        id: train
        run: |
          set -euo pipefail
          PAGE="$(curl -fsSL https://www.eclipse.org/downloads/packages/release)"
          TRAIN="$(printf '%s' "$PAGE" | grep -Eo '[0-9]{4}-[0-9]{2} R' | head -n1 | cut -d' ' -f1)"
          if [[ -z "${TRAIN:-}" ]]; then
            echo "Could not detect latest train" >&2
            exit 1
          fi
          echo "train=$TRAIN" >> "$GITHUB_OUTPUT"

      - name: Get latest SonarLint for Eclipse version (from GitHub Releases)
        id: sonarlint
        env:
          GH_TOKEN: ${{ github.token }}   # avoid rate limiting
        run: |
          set -euo pipefail
          JSON="$(curl -fsSL -H "Authorization: Bearer ${GH_TOKEN}" https://api.github.com/repos/SonarSource/sonarlint-eclipse/releases/latest)"
          VER="$(printf '%s' "$JSON" | jq -r '.tag_name' | sed 's/^v//')"
          if [[ -z "${VER:-}" || "${VER}" == "null" ]]; then
            echo "Failed to get SonarLint version from GitHub" >&2
            exit 1
          fi
          ZIP_URL="https://binaries.sonarsource.com/SonarLint-for-Eclipse/releases/org.sonarlint.eclipse.site-${VER}.zip"
          echo "version=$VER"     >> "$GITHUB_OUTPUT"
          echo "zip_url=$ZIP_URL" >> "$GITHUB_OUTPUT"

      - name: Decide release tag (skip if already published)
        id: decide
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          TRAIN="${{ steps.train.outputs.train }}"
          SL_VER="${{ steps.sonarlint.outputs.version }}"
          TAG="eclipse-java-${TRAIN}-win64-sonarlint-${SL_VER}"
          if gh release view "$TAG" >/dev/null 2>&1; then
            echo "skip=true"  >> "$GITHUB_OUTPUT"
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
          fi
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"

      - name: Stop early if release already exists
        if: steps.decide.outputs.skip == 'true'
        run: echo "Release ${{ steps.decide.outputs.tag }} already exists. Nothing to do."

      - name: Install build tools
        if: steps.decide.outputs.skip == 'false'
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y unzip zip xz-utils p7zip-full rsync jq

      - name: Download Eclipse (Windows x64) via mirrors with retry
        if: steps.decide.outputs.skip == 'false'
        id: dl
        run: |
          set -euo pipefail
          TRAIN="${{ steps.train.outputs.train }}"
          BASE="/technology/epp/downloads/release/${TRAIN}/R"
          WIN="eclipse-java-${TRAIN}-R-win32-x86_64.zip"

          pick_and_download () {
            local FILE="$1" OUT="$2"
            local XML_URL="https://www.eclipse.org/downloads/download.php?file=${BASE}/${FILE}&format=xml"
            local MIRRORS
            MIRRORS="$(curl -fsSL "$XML_URL" | grep -oP '(?<=url=").*?(?=")')"
            if [[ -z "${MIRRORS}" ]]; then
              echo "No mirrors found for ${FILE}" >&2
              exit 1
            fi
            for url in $MIRRORS; do
              echo "Trying $url"
              if curl -fSL --retry 3 --connect-timeout 20 "$url" -o "$OUT"; then
                echo "Downloaded $OUT from $url"
                return 0
              fi
            done
            echo "Failed to download $OUT from all mirrors" >&2
            exit 1
          }

          pick_and_download "$WIN" "$WIN"
          echo "windows=$WIN" >> "$GITHUB_OUTPUT"

      - name: Download SonarLint update-site ZIP
        if: steps.decide.outputs.skip == 'false'
        id: slzip
        run: |
          set -euo pipefail
          curl -fSL "${{ steps.sonarlint.outputs.zip_url }}" -o "sonarlint-site.zip"
          echo "file=sonarlint-site.zip" >> "$GITHUB_OUTPUT"

      - name: Build dropins from SonarLint update-site (Windows x64 sloop only)
        if: steps.decide.outputs.skip == 'false'
        id: dropins
        run: |
          set -euo pipefail
          # Unzip SonarLint p2 update site
          mkdir -p sl_site && unzip -q "${{ steps.slzip.outputs.file }}" -d sl_site

          # Prepare a portable dropins layout
          mkdir -p dropins/custom/eclipse/features dropins/custom/eclipse/plugins
          rsync -a sl_site/features/ dropins/custom/eclipse/features/
          rsync -a sl_site/plugins/  dropins/custom/eclipse/plugins/

          # Keep only Windows x64 sloop jar, expand it into a same-named directory, remove other sloop jars
          PLUGDIR="dropins/custom/eclipse/plugins"
          SLOOP_WIN="$(ls "$PLUGDIR"/org.sonarlint.eclipse.sloop.windows.x64_*.jar | head -n1 || true)"
          if [[ -z "${SLOOP_WIN:-}" ]]; then
            echo "Windows x64 sloop jar not found
